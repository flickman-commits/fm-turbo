// Trackstar Database Schema
// https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Order {
  id               String    @id @default(cuid())
  orderNumber      String    @unique
  source           String    // "shopify" or "etsy"
  arteloOrderData  Json      // Full order object from Artelo
  shopifyOrderData Json?     // Personalization data if Shopify
  raceName         String
  raceYear         Int
  runnerName       String
  productSize      String
  frameType        String
  notes            String?   // Notes from Shopify (year corrections, etc.)
  hadNoTime        Boolean   @default(false) // Flag: customer entered "no time" in runner name
  status           String    @default("pending") // "pending", "missing_year", "ready", "flagged", "completed"
  researchedAt     DateTime?
  createdAt        DateTime  @default(now())

  // Manual override fields (for customer corrections)
  yearOverride       Int?      // Override for raceYear
  raceNameOverride   String?   // Override for raceName
  runnerNameOverride String?   // Override for runnerName

  // Relations
  runnerResearch   RunnerResearch[]

  @@index([orderNumber])
  @@index([status])
  @@index([raceName, raceYear])
}

model Race {
  id               Int       @id @default(autoincrement())
  raceName         String
  year             Int
  raceDate         DateTime
  eventTypes       Json      // Array like ["Marathon", "Half Marathon"]
  resultsUrl       String?
  resultsSiteType  String?
  location         String?
  weatherCondition String?   // "sunny", "cloudy", or "rainy"
  weatherTemp      String?
  weatherFetchedAt DateTime?
  createdAt        DateTime  @default(now())

  // Relations
  runnerResearch   RunnerResearch[]

  @@unique([raceName, year])
  @@index([raceName])
  @@index([year])
}

model RunnerResearch {
  id             Int      @id @default(autoincrement())
  orderNumber    String
  raceId         Int
  runnerName     String
  bibNumber      String?
  officialTime   String?
  officialPace   String?
  eventType      String?  // "Marathon" or "Half Marathon"
  yearFound      Int?
  researchStatus String   @default("pending") // "found", "not_found", "ambiguous"
  researchNotes  String?
  createdAt      DateTime @default(now())

  // Relations
  order          Order    @relation(fields: [orderNumber], references: [orderNumber])
  race           Race     @relation(fields: [raceId], references: [id])

  @@index([orderNumber])
  @@index([raceId])
  @@index([researchStatus])
}
